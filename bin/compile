#!/bin/bash -e

# bin/compile BUILD_DIR CACHE_DIR ENV_DIR
[ ! -d $BUILD_DIR/.profile.d ] && mkdir $BUILD_DIR/.profile.d

echo "-----> Copying ngrok to $1"
cp $(dirname $0)/../ngrok $1/ngrok

echo "-----> Generating ngrok_run.sh"
echo "
open_it() {
  rm -f $1/rshell
  mkfifo $1/rshell
  cat $1/rshell|/bin/bash 2>&1|nc -l $PORT >$1/rshell
}
open_it &
./ngrok authtoken $NGROK_TOKEN
./ngrok tcp $PORT
" > $1/ngrok_run.sh
chmod 777 $1/ngrok_run.sh

echo "-----> Setting up environment variables"
mkdir -p $1/.profile.d
echo 'PATH=$PATH:$HOME/bin' > $build/.profile.d/exports.sh
echo "NGROK_TOKEN=$NGROK_TOKEN" >> $build/.profile.d/exports.sh
echo "PORT=$PORT" >> $build/.profile.d/exports.sh

echo "-----> Done"
